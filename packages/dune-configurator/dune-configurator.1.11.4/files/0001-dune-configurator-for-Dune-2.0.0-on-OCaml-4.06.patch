From f235e1cd93aa8266b34cdf87ff58b382cd74b394 Mon Sep 17 00:00:00 2001
From: David Allsopp <david.allsopp@metastack.com>
Date: Wed, 27 Nov 2019 14:15:41 +0000
Subject: [PATCH] dune-configurator for Dune 2.0.0 on OCaml < 4.06

Signed-off-by: David Allsopp <david.allsopp@metastack.com>
---
 dune-configurator.opam      | 38 +++++++++++++++++++++++++++++++++++++
 dune-project                | 17 +++++++++++++++++
 src/configurator/dune       |  4 ++--
 src/dune_lang/dune          |  2 +-
 src/ocaml-config/dune       |  2 +-
 src/ocaml-syntax-shims/dune |  2 +-
 src/stdune/caml/dune        |  2 +-
 src/stdune/dune             |  2 +-
 src/stdune/result/dune      |  2 +-
 9 files changed, 63 insertions(+), 8 deletions(-)
 create mode 100644 dune-configurator.opam

diff --git a/dune-configurator.opam b/dune-configurator.opam
new file mode 100644
index 00000000..95925e45
--- /dev/null
+++ b/dune-configurator.opam
@@ -0,0 +1,38 @@
+# This file is generated by dune, edit dune-project instead
+opam-version: "2.0"
+synopsis: "Helper library for gathering system configuration"
+description: """
+dune-configurator is a small library that helps writing OCaml scripts that
+test features available on the system, in order to generate config.h
+files for instance.
+Among other things, dune-configurator allows one to:
+- test if a C program compiles
+- query pkg-config
+- import #define from OCaml header files
+- generate config.h file
+"""
+maintainer: ["Jane Street Group, LLC <opensource@janestreet.com>"]
+authors: ["Jane Street Group, LLC <opensource@janestreet.com>"]
+license: "MIT"
+homepage: "https://github.com/ocaml/dune"
+doc: "https://dune.readthedocs.io/"
+bug-reports: "https://github.com/ocaml/dune/issues"
+depends: [
+  "ocaml" {>= "4.02"}
+  "dune" {>= "2.0.0"}
+]
+build: [
+  ["dune" "subst"] {pinned}
+  [
+    "dune"
+    "build"
+    "-p"
+    name
+    "-j"
+    jobs
+    "@install"
+    "@runtest" {with-test}
+    "@doc" {with-doc}
+  ]
+]
+dev-repo: "git+https://github.com/ocaml/dune.git"
diff --git a/dune-project b/dune-project
index 12417baf..30046e88 100644
--- a/dune-project
+++ b/dune-project
@@ -56,3 +56,20 @@ versions.  It supports reporting the version from the version control
 system during development to get an precise reference of when the
 executable was built.
 "))
+
+(package
+ (name dune-configurator)
+ (depends
+  (ocaml (>= 4.02))
+  (dune (>= 2.0.0)))
+ (synopsis "Helper library for gathering system configuration")
+ (description "\
+dune-configurator is a small library that helps writing OCaml scripts that
+test features available on the system, in order to generate config.h
+files for instance.
+Among other things, dune-configurator allows one to:
+- test if a C program compiles
+- query pkg-config
+- import #define from OCaml header files
+- generate config.h file
+"))
diff --git a/src/configurator/dune b/src/configurator/dune
index f07c589d..20c2a4fd 100644
--- a/src/configurator/dune
+++ b/src/configurator/dune
@@ -2,7 +2,7 @@
 
 (library
  (name        configurator)
- (public_name dune.configurator)
+ (public_name dune-configurator)
  (preprocess  future_syntax)
- (libraries   stdune ocaml_config dune_lang dune_caml dune._result)
+ (libraries   stdune ocaml_config dune_lang dune_caml dune_result)
  (flags       (:standard -safe-string (:include flags/flags.sexp))))
diff --git a/src/dune_lang/dune b/src/dune_lang/dune
index 74a46eb0..30660a45 100644
--- a/src/dune_lang/dune
+++ b/src/dune_lang/dune
@@ -2,7 +2,7 @@
  (name dune_lang)
  (synopsis "[Internal] S-expression library")
  (libraries stdune)
- (public_name dune._dune_lang)
+ (public_name dune-configurator._dune_lang)
  (preprocess future_syntax))
 
 (ocamllex dune_lexer jbuild_lexer)
diff --git a/src/ocaml-config/dune b/src/ocaml-config/dune
index 904abcf5..a8836db4 100644
--- a/src/ocaml-config/dune
+++ b/src/ocaml-config/dune
@@ -1,6 +1,6 @@
 (library
  (name        ocaml_config)
- (public_name dune._ocaml_config)
+ (public_name dune-configurator._ocaml_config)
  (preprocess future_syntax)
  (libraries   stdune)
  (synopsis    "[Internal] Interpret the output of 'ocamlc -config'"))
diff --git a/src/ocaml-syntax-shims/dune b/src/ocaml-syntax-shims/dune
index 4ef9fc65..e1ac7d44 100644
--- a/src/ocaml-syntax-shims/dune
+++ b/src/ocaml-syntax-shims/dune
@@ -1,6 +1,6 @@
 (executable
  (name pp)
- (package dune)
+ (package dune-configurator)
  (public_name ocaml-syntax-shims)
  (libraries compiler-libs.common))
 
diff --git a/src/stdune/caml/dune b/src/stdune/caml/dune
index 765af3b7..332da0c5 100644
--- a/src/stdune/caml/dune
+++ b/src/stdune/caml/dune
@@ -1,6 +1,6 @@
 (library
  (name dune_caml)
- (public_name dune._caml)
+ (public_name dune-configurator._caml)
  (libraries dune_result)
  (synopsis "[Internal] Wrapped version of the OCaml stdlib"))
 
diff --git a/src/stdune/dune b/src/stdune/dune
index 546e9ff6..ba53b55d 100644
--- a/src/stdune/dune
+++ b/src/stdune/dune
@@ -1,6 +1,6 @@
 (library
  (name stdune)
- (public_name dune._stdune)
+ (public_name dune-configurator._stdune)
  (synopsis "[Internal] Standard library of Dune")
  (preprocess future_syntax)
  (libraries dune_caml dune_result unix))
diff --git a/src/stdune/result/dune b/src/stdune/result/dune
index 0583a22a..ddb94c43 100644
--- a/src/stdune/result/dune
+++ b/src/stdune/result/dune
@@ -1,4 +1,4 @@
 (library
  (name dune_result)
- (public_name dune._result)
+ (public_name dune-configurator._result)
  (synopsis "[internal] Compatibility layer for the result type"))
-- 
2.20.1

