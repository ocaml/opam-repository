Improve location handling in the middle-end